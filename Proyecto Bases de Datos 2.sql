CREATE DATABASE PROYECTO
GO

USE PROYECTO
GO

Alter authorization on database::PROYECTO to sa 
GO 

SET DATEFORMAT dmy 
SET LANGUAGE spanish 
GO


/*CREACIÓN DE LAS TABLAS*/
CREATE TABLE CATEGORIAS(
	ID_CATEGORIA INT NOT NULL, 
	NOMBRE VARCHAR (50) NOT NULL,
	CONSTRAINT PK_CATEGORIAS PRIMARY KEY (ID_CATEGORIA))
GO

CREATE TABLE ROL (
	ID_ROL INT NOT NULL,
	NOMBRE VARCHAR(25) NOT NULL,
	CONSTRAINT PK_ROL PRIMARY KEY (ID_ROL)
)
GO

CREATE TABLE USUARIOS(
	ID_USUARIO INT NOT NULL,
	CONTRASENA VARCHAR(30) NOT NULL,
	NOMBRE_COMPLETO VARCHAR(60) NOT NULL,
	TELEFONO VARCHAR(12) NOT NULL,
	CORREO VARCHAR(30) NOT NULL,
	ID_ROL INT NOT NULL,
	CONSTRAINT PK_USUARIOS PRIMARY KEY (ID_USUARIO),
	CONSTRAINT FK_ROL_USUARIOS FOREIGN KEY (ID_ROL) REFERENCES ROL(ID_ROL)
)
GO

CREATE TABLE ESTADOS(
	ID_ESTADO INT NOT NULL,
	NOMBRE VARCHAR(60) NOT NULL,
	CONSTRAINT PK_ESTADOS PRIMARY KEY (ID_ESTADO)
)
GO

CREATE TABLE INCIDENTES(
	CODIGO_INCIDENTE INT IDENTITY NOT NULL,
	DETALLE VARCHAR(100) NOT NULL,
	FECHA_INGRESO DATE NOT NULL,
	CATEGORIA INT NOT NULL,
	ID_USUARIO INT NOT NULL,
	ESTADO_ACTUAL INT NOT NULL,
	ID_ESPECIALISTA INT,
	CONSTRAINT PK_INCIDENTES PRIMARY KEY (CODIGO_INCIDENTE),
	CONSTRAINT FK_CATEGORIAS_INCIDENTES FOREIGN KEY (CATEGORIA) REFERENCES CATEGORIAS(ID_CATEGORIA),
	CONSTRAINT FK_USUARIOS_INCIDENTES FOREIGN KEY (ID_USUARIO) REFERENCES USUARIOS(ID_USUARIO),
	CONSTRAINT FK_ESPECIALISTAS_INCIDENTES FOREIGN KEY (ID_ESPECIALISTA) REFERENCES USUARIOS(ID_USUARIO),
	CONSTRAINT FK_ESTADOS_INCIDENTES FOREIGN KEY (ESTADO_ACTUAL) REFERENCES ESTADOS(ID_ESTADO)
)
GO


CREATE TABLE BITACORA(
	CODIGO_BIT INT IDENTITY NOT NULL,
	CODIGO_INCIDENTE INT NOT NULL,
	FECHA_CREACION DATE NOT NULL,
	ESTADO_ANTERIOR INT NOT NULL,
	ESTADO_ACTUAL INT NOT NULL,
	CONSTRAINT PK_BITACORA PRIMARY KEY (CODIGO_BIT),
	CONSTRAINT FK_INCIDENTES_BITACORA FOREIGN KEY (CODIGO_INCIDENTE) REFERENCES INCIDENTES(CODIGO_INCIDENTE),
	CONSTRAINT FK_ESTADOS_BITACORA1 FOREIGN KEY (ESTADO_ANTERIOR) REFERENCES ESTADOS(ID_ESTADO),
	CONSTRAINT FK_ESTADOS_BITACORA2 FOREIGN KEY (ESTADO_ACTUAL) REFERENCES ESTADOS(ID_ESTADO)
)
GO



/*INSERTS*/
--INSERT TABLA CATEGORÍAS
INSERT INTO [dbo].[CATEGORIAS] ([ID_CATEGORIA], [NOMBRE])
	VALUES (1, 'Telefonia Tradicional')
INSERT INTO [dbo].[CATEGORIAS] ([ID_CATEGORIA], [NOMBRE])
	VALUES (2, 'Telefonia VOZ IP')
INSERT INTO [dbo].[CATEGORIAS] ([ID_CATEGORIA], [NOMBRE])
	VALUES (3, 'Errores en sistemas de informacion')
INSERT INTO [dbo].[CATEGORIAS] ([ID_CATEGORIA], [NOMBRE])
	VALUES (4, 'Errores de red')
INSERT INTO [dbo].[CATEGORIAS] ([ID_CATEGORIA], [NOMBRE])
	VALUES (5, 'Errores en las computadoras')
INSERT INTO [dbo].[CATEGORIAS] ([ID_CATEGORIA], [NOMBRE])
	VALUES (6, 'Impresoras')
GO



--INSERT TABLA ROLES
INSERT INTO [dbo].[ROL] ([ID_ROL], [NOMBRE])
	VALUES (1, 'Coordinador')
INSERT INTO [dbo].[ROL] ([ID_ROL], [NOMBRE])
	VALUES (2, 'Usuario')
INSERT INTO [dbo].[ROL] ([ID_ROL], [NOMBRE])
	VALUES (3, 'Especialista')
GO



--INSERT TABLA USUARIOS
INSERT INTO [dbo].[USUARIOS] ([ID_USUARIO], [CONTRASENA], [NOMBRE_COMPLETO], [TELEFONO], [CORREO], [ID_ROL])
	VALUES (1, '*123#', 'Matías García Soto', '45789632', 'mati006@esty.wq', 1)
INSERT INTO [dbo].[USUARIOS] ([ID_USUARIO], [CONTRASENA], [NOMBRE_COMPLETO], [TELEFONO], [CORREO], [ID_ROL])
	VALUES (2, 'villaXx', 'Karol López Villalobos', '80174350', 'Kar18V@pop.mm', 1)
INSERT INTO [dbo].[USUARIOS] ([ID_USUARIO], [CONTRASENA], [NOMBRE_COMPLETO], [TELEFONO], [CORREO], [ID_ROL])
	VALUES (3, 'varguido', 'Nicolás Vargas Guido', '77020966', 'guido111@yop.yy', 1)
INSERT INTO [dbo].[USUARIOS] ([ID_USUARIO], [CONTRASENA], [NOMBRE_COMPLETO], [TELEFONO], [CORREO], [ID_ROL])
	VALUES (4, 'cube190', 'Ashley Cubero Fernández', '89503399', 'Ashq.90@pop.mm', 1)
INSERT INTO [dbo].[USUARIOS] ([ID_USUARIO], [CONTRASENA], [NOMBRE_COMPLETO], [TELEFONO], [CORREO], [ID_ROL])
	VALUES (5, 'danitaglia', 'Daniel Tagliafico Bermúdez', '50603040', 'bermúdez0102@yuti.pp', 2)
INSERT INTO [dbo].[USUARIOS] ([ID_USUARIO], [CONTRASENA], [NOMBRE_COMPLETO], [TELEFONO], [CORREO], [ID_ROL])
	VALUES (6, '12ortiz34', 'Fernanda Ortiz Garro', '52003644', 'garro1234@pop.mm', 2)
INSERT INTO [dbo].[USUARIOS] ([ID_USUARIO], [CONTRASENA], [NOMBRE_COMPLETO], [TELEFONO], [CORREO], [ID_ROL])
	VALUES (7, 'juancho000', 'Juan Quito Guzmán', '04059080', 'quitoJG@hos.pp', 2)
INSERT INTO [dbo].[USUARIOS] ([ID_USUARIO], [CONTRASENA], [NOMBRE_COMPLETO], [TELEFONO], [CORREO], [ID_ROL])
	VALUES (8, 'celes0612', 'Celeste Camaño Canet', '23560401', 'camañoCC@pop.mm', 2)
INSERT INTO [dbo].[USUARIOS] ([ID_USUARIO], [CONTRASENA], [NOMBRE_COMPLETO], [TELEFONO], [CORREO], [ID_ROL])
	VALUES (9, 'Sau987', 'Saúl Barrantes Jiménez', '45668880', 'sbjiménez.45@hos.wq', 3)
INSERT INTO [dbo].[USUARIOS] ([ID_USUARIO], [CONTRASENA], [NOMBRE_COMPLETO], [TELEFONO], [CORREO], [ID_ROL])
	VALUES (10, 'xXmariXx', 'María Villegas López', '22233300', 'villeL3344@yop.yy', 3)
INSERT INTO [dbo].[USUARIOS] ([ID_USUARIO], [CONTRASENA], [NOMBRE_COMPLETO], [TELEFONO], [CORREO], [ID_ROL])
	VALUES (11, 'dylanzzz', 'Dylan Contreras Aguilera', '65002211', 'contreras22@yuop.wq', 3)
INSERT INTO [dbo].[USUARIOS] ([ID_USUARIO], [CONTRASENA], [NOMBRE_COMPLETO], [TELEFONO], [CORREO], [ID_ROL])
	VALUES (12, 'silvialeon', 'Silvia León Lozano', '40502211', 'silvia.leo@hos.pp', 3)
INSERT INTO [dbo].[USUARIOS] ([ID_USUARIO], [CONTRASENA], [NOMBRE_COMPLETO], [TELEFONO], [CORREO], [ID_ROL])
	VALUES (13, 'criscrr', 'Cristian Rojas Rodriguez', '22568825', 'rojas.ro@pop.mm', 1)
INSERT INTO [dbo].[USUARIOS] ([ID_USUARIO], [CONTRASENA], [NOMBRE_COMPLETO], [TELEFONO], [CORREO], [ID_ROL])
	VALUES (14, 'marielsoto00000', 'Mariel Soto Vargas', '78000063', 'sotovargas.11@hos.pp', 1)
INSERT INTO [dbo].[USUARIOS] ([ID_USUARIO], [CONTRASENA], [NOMBRE_COMPLETO], [TELEFONO], [CORREO], [ID_ROL])
	VALUES (15, 'chinchilla222', 'Esteban Chinchilla Ramírez', '36098888', 'estebanCR@hos.mm', 1)
INSERT INTO [dbo].[USUARIOS] ([ID_USUARIO], [CONTRASENA], [NOMBRE_COMPLETO], [TELEFONO], [CORREO], [ID_ROL])
	VALUES (16, 'guzmánsanchez', 'Camila Guzmán Sánchez', '40563337', 'sánchez.89@pop.yy', 1)
INSERT INTO [dbo].[USUARIOS] ([ID_USUARIO], [CONTRASENA], [NOMBRE_COMPLETO], [TELEFONO], [CORREO], [ID_ROL])
	VALUES (17, '123456789', 'Jeremy Jara Madrigal', '12893456', 'jaramadri.2@yop.pp', 2)
INSERT INTO [dbo].[USUARIOS] ([ID_USUARIO], [CONTRASENA], [NOMBRE_COMPLETO], [TELEFONO], [CORREO], [ID_ROL])
	VALUES (18, '09aguero08', 'Jimena Rojas Aguero', '20333066', 'rojasJA@hos.mm', 2)
INSERT INTO [dbo].[USUARIOS] ([ID_USUARIO], [CONTRASENA], [NOMBRE_COMPLETO], [TELEFONO], [CORREO], [ID_ROL])
	VALUES (19, 'lius56789', 'Luis Castro Baltodano', '66633300', 'castro.901@pop.yop', 2)
INSERT INTO [dbo].[USUARIOS] ([ID_USUARIO], [CONTRASENA], [NOMBRE_COMPLETO], [TELEFONO], [CORREO], [ID_ROL])
	VALUES (20, 'vero98765', 'Verónica Murillo Chaves', '11220011', 'chavesMurillo@yuop.wq', 2)
INSERT INTO [dbo].[USUARIOS] ([ID_USUARIO], [CONTRASENA], [NOMBRE_COMPLETO], [TELEFONO], [CORREO], [ID_ROL])
	VALUES (21, 'SebasCR', 'Sebastian Ortiz Arguedas', '52336655', 'ortiz17@hos.pp', 3)
INSERT INTO [dbo].[USUARIOS] ([ID_USUARIO], [CONTRASENA], [NOMBRE_COMPLETO], [TELEFONO], [CORREO], [ID_ROL])
	VALUES (22, 'Dani0987654321', 'Daniela Chacón Duarte', '03226677', 'duarte000@pop.yy', 3)
INSERT INTO [dbo].[USUARIOS] ([ID_USUARIO], [CONTRASENA], [NOMBRE_COMPLETO], [TELEFONO], [CORREO], [ID_ROL])
	VALUES (23, 'alefonse', 'Alejandro Fonseca Chavarría', '45888888', 'fonsecaChava@hos.wq', 3)
INSERT INTO [dbo].[USUARIOS] ([ID_USUARIO], [CONTRASENA], [NOMBRE_COMPLETO], [TELEFONO], [CORREO], [ID_ROL])
	VALUES (24, 'valeHerra', 'Valeria Herra Córdoba', '66633300', 'herraVale@yuop.mm', 3)
GO



--INSERT TABLA ESTADOS
INSERT INTO [dbo].[ESTADOS] ([ID_ESTADO], [NOMBRE])
	VALUES (1, 'PENDIENTE ASIGNAR- PA')
INSERT INTO [dbo].[ESTADOS] ([ID_ESTADO], [NOMBRE])
	VALUES (2, 'INCIDENTE ASIGNADO- IA')
INSERT INTO [dbo].[ESTADOS] ([ID_ESTADO], [NOMBRE])
	VALUES (3, 'INCIDENTE EN DESARROLLO- ID')
INSERT INTO [dbo].[ESTADOS] ([ID_ESTADO], [NOMBRE])
	VALUES (4, 'INCIDENTE EN PRUEBAS- IP')
INSERT INTO [dbo].[ESTADOS] ([ID_ESTADO], [NOMBRE])
	VALUES (5, 'INCIDENTE CERRADO- IC')
GO



--INSERT TABLA INCIDENTES
INSERT INTO [dbo].[INCIDENTES] ([DETALLE], [FECHA_INGRESO], [CATEGORIA], [ID_USUARIO], [ESTADO_ACTUAL])
	VALUES ('La impresora no prende', '12-12-2020', 6, 5, 1)--
INSERT INTO [dbo].[INCIDENTES] ([DETALLE], [FECHA_INGRESO], [CATEGORIA], [ID_USUARIO], [ESTADO_ACTUAL], [ID_ESPECIALISTA])
	VALUES ('La computadora se reinicia', '17-09-2020', 5, 7, 2, 12)--
INSERT INTO [dbo].[INCIDENTES] ([DETALLE], [FECHA_INGRESO], [CATEGORIA], [ID_USUARIO], [ESTADO_ACTUAL], [ID_ESPECIALISTA])
	VALUES ('No se guarda el documento', '18-02-2020', 3, 20, 3, 24)--
INSERT INTO [dbo].[INCIDENTES] ([DETALLE], [FECHA_INGRESO], [CATEGORIA], [ID_USUARIO], [ESTADO_ACTUAL])
	VALUES ('No hay internet', '05-08-2020', 4, 17, 1)--
INSERT INTO [dbo].[INCIDENTES] ([DETALLE], [FECHA_INGRESO], [CATEGORIA], [ID_USUARIO], [ESTADO_ACTUAL])
	VALUES ('La impresora imprime a rayas', '29-07-2020', 6, 7, 1)--
INSERT INTO [dbo].[INCIDENTES] ([DETALLE], [FECHA_INGRESO], [CATEGORIA], [ID_USUARIO], [ESTADO_ACTUAL], [ID_ESPECIALISTA])
	VALUES ('No hay tono', '26-06-2020', 1, 19, 2, 21)
INSERT INTO [dbo].[INCIDENTES] ([DETALLE], [FECHA_INGRESO], [CATEGORIA], [ID_USUARIO], [ESTADO_ACTUAL], [ID_ESPECIALISTA])
	VALUES ('La computadora prende y se apaga', '08-01-2020', 5, 6, 3, 12)
INSERT INTO [dbo].[INCIDENTES] ([DETALLE], [FECHA_INGRESO], [CATEGORIA], [ID_USUARIO], [ESTADO_ACTUAL], [ID_ESPECIALISTA])
	VALUES ('El internet se va y regresa constantemente', '15-12-2019', 4, 8, 4, 10)
INSERT INTO [dbo].[INCIDENTES] ([DETALLE], [FECHA_INGRESO], [CATEGORIA], [ID_USUARIO], [ESTADO_ACTUAL], [ID_ESPECIALISTA])
	VALUES ('Error en el disco duro', '20-10-2019', 5, 9, 5, 23)
INSERT INTO [dbo].[INCIDENTES] ([DETALLE], [FECHA_INGRESO], [CATEGORIA], [ID_USUARIO], [ESTADO_ACTUAL])
	VALUES ('La pantalla de la computadora se queda en negro', '2001-03-23', 5, 5, 1)
GO



--INSERT TABLA BITÁCORA
INSERT INTO [dbo].[BITACORA] ([CODIGO_INCIDENTE], [FECHA_CREACION], [ESTADO_ANTERIOR], [ESTADO_ACTUAL])
	VALUES (1, '12-12-2020', 1, 1)
INSERT INTO [dbo].[BITACORA] ([CODIGO_INCIDENTE], [FECHA_CREACION], [ESTADO_ANTERIOR], [ESTADO_ACTUAL])
	VALUES (2, '17-09-2020', 1, 1)
INSERT INTO [dbo].[BITACORA] ([CODIGO_INCIDENTE], [FECHA_CREACION], [ESTADO_ANTERIOR], [ESTADO_ACTUAL])
	VALUES (2, '20-01-2019', 1, 2)
INSERT INTO [dbo].[BITACORA] ([CODIGO_INCIDENTE], [FECHA_CREACION], [ESTADO_ANTERIOR], [ESTADO_ACTUAL])
	VALUES (3, '18-02-2020', 1, 1)
INSERT INTO [dbo].[BITACORA] ([CODIGO_INCIDENTE], [FECHA_CREACION], [ESTADO_ANTERIOR], [ESTADO_ACTUAL])
	VALUES (3, '21-02-2020', 1, 2)
INSERT INTO [dbo].[BITACORA] ([CODIGO_INCIDENTE], [FECHA_CREACION], [ESTADO_ANTERIOR], [ESTADO_ACTUAL])
	VALUES (3, '23-02-2020', 2, 3)
INSERT INTO [dbo].[BITACORA] ([CODIGO_INCIDENTE], [FECHA_CREACION], [ESTADO_ANTERIOR], [ESTADO_ACTUAL])
	VALUES (4, '08-05-2020', 1, 1)
INSERT INTO [dbo].[BITACORA] ([CODIGO_INCIDENTE], [FECHA_CREACION], [ESTADO_ANTERIOR], [ESTADO_ACTUAL])
	VALUES (5, '29-07-2020', 1, 1)
INSERT INTO [dbo].[BITACORA] ([CODIGO_INCIDENTE], [FECHA_CREACION], [ESTADO_ANTERIOR], [ESTADO_ACTUAL])
	VALUES (6, '28-06-2020', 1, 1)
INSERT INTO [dbo].[BITACORA] ([CODIGO_INCIDENTE], [FECHA_CREACION], [ESTADO_ANTERIOR], [ESTADO_ACTUAL])
	VALUES (6, '30-06-2020', 1, 2)
INSERT INTO [dbo].[BITACORA] ([CODIGO_INCIDENTE], [FECHA_CREACION], [ESTADO_ANTERIOR], [ESTADO_ACTUAL])
	VALUES (7, '08-01-2020', 1, 1)
INSERT INTO [dbo].[BITACORA] ([CODIGO_INCIDENTE], [FECHA_CREACION], [ESTADO_ANTERIOR], [ESTADO_ACTUAL])
	VALUES (7, '10-01-2020', 1, 2)
INSERT INTO [dbo].[BITACORA] ([CODIGO_INCIDENTE], [FECHA_CREACION], [ESTADO_ANTERIOR], [ESTADO_ACTUAL])
	VALUES (7, '13-08-2020', 2, 3)
INSERT INTO [dbo].[BITACORA] ([CODIGO_INCIDENTE], [FECHA_CREACION], [ESTADO_ANTERIOR], [ESTADO_ACTUAL])
	VALUES (8, '15-12-2019', 1, 1)
INSERT INTO [dbo].[BITACORA] ([CODIGO_INCIDENTE], [FECHA_CREACION], [ESTADO_ANTERIOR], [ESTADO_ACTUAL])
	VALUES (8, '17-12-2020', 1, 2)
INSERT INTO [dbo].[BITACORA] ([CODIGO_INCIDENTE], [FECHA_CREACION], [ESTADO_ANTERIOR], [ESTADO_ACTUAL])
	VALUES (8, '18-12-2020', 2, 3)
INSERT INTO [dbo].[BITACORA] ([CODIGO_INCIDENTE], [FECHA_CREACION], [ESTADO_ANTERIOR], [ESTADO_ACTUAL])
	VALUES (8, '19-12-2020', 3, 4)
INSERT INTO [dbo].[BITACORA] ([CODIGO_INCIDENTE], [FECHA_CREACION], [ESTADO_ANTERIOR], [ESTADO_ACTUAL])
	VALUES (9, '20-10-2019', 1, 1)
INSERT INTO [dbo].[BITACORA] ([CODIGO_INCIDENTE], [FECHA_CREACION], [ESTADO_ANTERIOR], [ESTADO_ACTUAL])
	VALUES (9, '21-10-2019', 1, 2)
INSERT INTO [dbo].[BITACORA] ([CODIGO_INCIDENTE], [FECHA_CREACION], [ESTADO_ANTERIOR], [ESTADO_ACTUAL])
	VALUES (9, '22-10-2019', 2, 3)
INSERT INTO [dbo].[BITACORA] ([CODIGO_INCIDENTE], [FECHA_CREACION], [ESTADO_ANTERIOR], [ESTADO_ACTUAL])
	VALUES (9, '26-10-2019', 3, 4)
INSERT INTO [dbo].[BITACORA] ([CODIGO_INCIDENTE], [FECHA_CREACION], [ESTADO_ANTERIOR], [ESTADO_ACTUAL])
	VALUES (9, '27-10-2019', 4, 5)
INSERT INTO [dbo].[BITACORA] ([CODIGO_INCIDENTE], [FECHA_CREACION], [ESTADO_ANTERIOR], [ESTADO_ACTUAL])
	VALUES (12, '2021-03-23', 1, 1)
GO



/*3.Función que liste la cantidad de casos ingresados por un usuario en particular, en un rango de fechas en particular.
    Recibiendo por parámetros el usuario y las fechas de la consulta. (10 pts)*/
CREATE FUNCTION fn_Casos_Ingresados (@Usuario int,@Fecha1 date, @Fecha2 date)
RETURNS INT

AS BEGIN

	RETURN (SELECT COUNT([ID_USUARIO]) AS CANTIDAD_DE_CASOS
	FROM [dbo].[INCIDENTES]
	WHERE [ID_USUARIO] = @Usuario AND [FECHA_INGRESO] BETWEEN @Fecha1 AND @Fecha2)

END
GO

-- INVOCAR FUNCION
SELECT [dbo].[fn_Casos_Ingresados] (7, '2020-01-01', '2021-01-01')
GO



/*4.Función que liste la cantidad de casos atendidos por un especialista en particular, en un rango de fechas en particular. 
    Recibiendo por parámetros el especialista y las fechas de la consulta. (10 pts)*/

CREATE FUNCTION fn_Casos_Atendidos (@Especialista int)
RETURNS INT

AS BEGIN

	RETURN( SELECT COUNT([ID_ESPECIALISTA]) AS CASOS_ATENDIDOS
	FROM [dbo].[INCIDENTES]
	WHERE [ID_ESPECIALISTA] = @Especialista)

END
GO


-- INVOCAR FUNCION
SELECT [dbo].[fn_Casos_Atendidos] (12) AS CASOS_ATENDIDOS
GO



/*5.Desarrolle una Vista que liste todos los Incidentes Pendientes de Asignar. (5 pts)*/
CREATE VIEW ListaIncidentesPA
AS
	SELECT [CODIGO_INCIDENTE], [DETALLE], [FECHA_INGRESO], [CATEGORIA], [ID_USUARIO], [ID_ESPECIALISTA] 
	FROM [dbo].[INCIDENTES] WHERE [ESTADO_ACTUAL] = 1
GO

SELECT * FROM [dbo].[ListaIncidentesPA]



/*6.Procedimiento almacenado que permita cambiar el Estado de un Incidente. Recibiendo el número de incidente 
	y el nuevo estado. (15 pts)
	a.	Validar que el incidente exista, el nuevo estado sea válido (5 pts).
	b.	Uso de Try Catch y Transacciones. (5 pts)
	c.	Cambio del Estado del Incidente. (5 pts)
*/
CREATE PROCEDURE pa_ESTADO_INCIDENTE @COD_INCIDENTE INT, @ESTADO INT
AS BEGIN
	
	--SI EL INCIDENTE EXISTE
	IF EXISTS(SELECT * FROM [dbo].[INCIDENTES]
		WHERE [CODIGO_INCIDENTE] = @COD_INCIDENTE) BEGIN
	
		--SI EL ESTADO ES VÁLIDO
		IF EXISTS(SELECT * FROM [dbo].[ESTADOS]
			WHERE [ID_ESTADO] = @ESTADO) BEGIN

			--SE REALIZA EL  UPDATE
			SET IMPLICIT_TRANSACTIONS ON
			BEGIN TRY
				
				UPDATE [dbo].[INCIDENTES]
				SET [ESTADO_ACTUAL] = @ESTADO
				WHERE [CODIGO_INCIDENTE] = @COD_INCIDENTE
				COMMIT TRANSACTION

			END TRY
			BEGIN CATCH
				
				ROLLBACK
				PRINT 'Error al actualizar el estado'
			END CATCH
		END
		ELSE BEGIN
			PRINT 'El estado ingresado no es válido'
		END
	END
	ELSE BEGIN
		PRINT 'El incidente ingresado no existe'
	END
END
GO


EXECUTE pa_ESTADO_INCIDENTE 2, 4
GO

/*7.Trigger asociado a la tabla de Incidentes que responda a los UPDATE de Estados, y que debe
crear el registro en el Histórico de incidentes, registrando: el código del Incidente y la 
fecha de modificación, el estado anterior y el estado actual. (10 pts).
a.	Uso de Try Catch. (5 pts)
b.	Registro del Histórico. (5 pts)
*/
CREATE TRIGGER TR_UpdateEstado ON [dbo].[INCIDENTES]
	AFTER UPDATE
AS
BEGIN
	SET NOCOUNT ON;
	DECLARE @CODIGO_INCIDENTE INT 
	DECLARE @FECHA_MOD DATE 
	DECLARE @ESTADO_ANTERIOR INT 
	DECLARE @ESTADO_ACTUAL INT 


	--SELECT @CODIGO_INCIDENTE = [CODIGO_INCIDENTE]
	--from INCIDENTES
	
	SELECT @CODIGO_INCIDENTE = [CODIGO_INCIDENTE], @ESTADO_ANTERIOR = [ESTADO_ACTUAL]
	FROM deleted
	SELECT @CODIGO_INCIDENTE = [CODIGO_INCIDENTE], @ESTADO_ACTUAL = [ESTADO_ACTUAL]
	FROM inserted

	BEGIN TRY
		INSERT INTO [dbo].[BITACORA]
			VALUES (@CODIGO_INCIDENTE,GETDATE(),@ESTADO_ANTERIOR,@ESTADO_ACTUAL)
	END TRY
	BEGIN CATCH
		PRINT 'Error al insertar la bitácora'
	END CATCH
END
GO